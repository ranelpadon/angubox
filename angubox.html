<!DOCTYPE html>
<html>
  <head>
    <title>Angubox: Angular + Mapbox</title>
    <script src='http://code.jquery.com/jquery-1.4.4.min.js'></script>
    <link href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://api.tiles.mapbox.com/mapbox.js/v2.2.0/mapbox.css" rel="stylesheet">
    <script src= "https://api.tiles.mapbox.com/mapbox.js/v2.2.0/mapbox.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.4.2/angular.js"></script>
    <script>
      var mapboxApp = angular.module('mapbox', []);

      mapboxApp.controller('MapboxController', function MapboxController($scope) {
        $scope.places = [
            { name:'Alpha', category:'Restaurant', lat: 15, lng: 121 },
            { name:'Beta', category:'Hotel', lat: 13, lng: 121 },
            { name:'Gamma', category:'Hotel', lat: 10, lng: 119 },
            { name:'Delta', category:'Hotel', lat: 9, lng: 125 },
            { name:'Zeta', category:'Restaurant', lat: 10.9, lng: 121 },
        ];

        $scope.categories = [ 'All', 'Hotel', 'Restaurant'];

        $scope.refreshPlaces = function() {
          zoomToMarkersExtent($scope.filteredPlaces);
        };

        function renderMarkers(places) {
          var latitude_0 = places[0].lat;
          var longitude_0 = places[0].lng;
          var southWest = L.latLng(latitude_0, longitude_0);
          var northEast = L.latLng(latitude_0, longitude_0);

          var currentBounds = L.latLngBounds(southWest, northEast);

          $scope.markers = {};
          for (var i = 0; i < places.length; i++) {
            var lat = places[i].lat;
            var lng = places[i].lng;

            // Set the position of the new marker.
            var marker = L.marker([lat, lng]);

            // Set the contents of the marker's popup.
            var popupText = places[i].name + ' ' + places[i].category;
            marker.bindPopup(popupText);

            // Add the new marker to the map.
            marker.addTo($scope.map);

            $scope.markers[places[i].name] = marker;

            var markerLatLng = L.latLng(lat, lng);
            currentBounds.extend(markerLatLng);
          }

          $scope.map.fitBounds(currentBounds);
        }

        function zoomToMarkersExtent(places) {
          // Hide all markers first.
          var length = $scope.places.length;
          for (var i = 0; i < length; i++) {
            var marker = $scope.markers[$scope.places[i].name];
            marker.setOpacity(0);
          }

          if($scope.placeName === 'All') {
            places = $scope.places;
          }

          var latitude_0 = places[0].lat;
          var longitude_0 = places[0].lng;
          var southWest = L.latLng(latitude_0, longitude_0);
          var northEast = L.latLng(latitude_0, longitude_0);

          var currentBounds = L.latLngBounds(southWest, northEast);

          var length = places.length;
          for (var i = 0; i < length; i++) {
            var marker = $scope.markers[places[i].name];
            marker.setOpacity(1);

            var lat = places[i].lat;
            var lng = places[i].lng;

            var markerLatLng = L.latLng(lat, lng);
            currentBounds.extend(markerLatLng);
          }

          $scope.map.fitBounds(currentBounds);
        }

        $scope.initializeMap = function() {
          var mapboxAccessToken = 'pk.eyJ1IjoicmFuZWxwYWRvbiIsImEiOiI3MGU3MTE5YTA3YmIzMjFlMWNkZGEyYmMxMDBkMDllNCJ9.HCrv6s66Cl5sKs87Plct8w';

          if (L.mapbox.accessToken == null) {
            L.mapbox.accessToken = mapboxAccessToken;
          }

          var mapDiv = document.getElementById('mapContainer');

          // Set the map's root container and layer type.
          $scope.map = L.mapbox.map(mapDiv, 'mapbox.streets');

          $scope.map.zoomControl.setPosition('topright');

          renderMarkers($scope.places);
        };

        $scope.initializeMap();
      });
    </script>
  </head>
  <body ng-app="mapbox">
    <div class="container" ng-controller="MapboxController">
      <br />
      <p class="well lead">Angubox: Angular + Mapbox</p>
      <label>Search places based on Category:</label>
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-4">
            <div>
              <select class="form-control" ng-model="placeName" ng-init="placeName='All'" ng-options="category for category in categories" ng-change="filteredPlaces = (places | filter:placeName); refreshPlaces()">
              </select>
            </div>
            <hr />
            <div>
              <ul class="list-group">
                <li class="list-group-item" ng-if="placeName == 'All'" ng-repeat="p in places">
                  {{ (p.name) + ' ' + p.category + ' @ Lat: ' + p.lat + ' Lon: ' + p.lng }}
                </li>
                <li class="list-group-item" ng-if="placeName != 'All'" ng-repeat="p in places | filter:placeName">
                  {{ (p.name) + ' ' + p.category + ' @ Lat: ' + p.lat + ' Lon: ' + p.lng }}
                </li>
              </ul>
            </div>
          </div>
          <div class="col-md-8">
            <div id="mapContainer" style="width: 100%; height: 500px;">
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
